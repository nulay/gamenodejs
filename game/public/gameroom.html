<html>

<head>
    <title>Login Here</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script type="text/javascript" src="js/YConsole-compiled.js"></script>
    <script type="text/javascript">
           YConsole.activate();
           console.log("first intercepted log.");
           YConsole.docking="bottom";
           YConsole.show();
    </script>
</head>

<body class="container">
    <div class="page-header">
        <h1>Game Room</h1>
    </div>

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/signup">Sign Up</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/login">Log In</a></li>
                    <li><a href="/logout">Log Out</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <form id="createForm" action="/gameroom" method="post" style="">
        <div>Type game:
           <select id="typeGame" name="typegame"></select>
        </div>
        <div>
           Count of users : <div id="silImg" style="margin:5px 15px;"></div>
           <input type="hidden" name="countUs" class="countUs" value="2"/>
        </div>
        <input type="submit" value="Создать игру"/>
            
    </form>
    

    <div id="listGames" style="min-height: 500px;">

    </div>

    <script type="application/javascript">
     var Room = {            
            init: function(maxuser) {
                this.countUs = 2;
                var thisEl = this;
                var imgSel = $('<img src="/images/siluetsel.png" width="20"/>').attr("ind", "2");
                jQuery('#silImg').empty().append(imgSel);
                for(var i=1;i<maxuser;i++){
                   jQuery('#silImg').append(imgSel.clone().attr("ind", ""+(i+1)));
                }
                this.unsel(2);
                $('#silImg img').click(function(el) {
                    thisEl.unsel(parseInt($(el.target).attr('ind')));
                });
            },
            unselSiluet: function(el, ind) {
                if (ind == 0) {
                    unsel(ind);
                }
            },
            unsel: function(ind) {
                $('.countUs').val(ind);
                console.log('unsel='+$('.countUs').val());
                this.countUs = ind;
                var mi = $("#silImg img");
                mi.attr('src', '/images/siluetsel.png');
                for (var i = ind; i < mi.length; i++) {
                    $(mi[i]).attr('src', '/images/siluet.png');
                }
            }
        }


        var objRoom = {            
            init: function() {
                var thisEl = this;
                this.loadRoomSettings();
                this.loadAllGame();
                //this.createForm();
                $('#typeGame').change(function(){
                           console.log(JSON.stringify(thisEl));
                           thisEl.changeRoom();    
                });               
                // this is the id of the form
                $("#createForm").submit(function(e) {
                     e.preventDefault(); // avoid to execute the actual submit of the form.
        
                     var form = $(this);
                     var url = form.attr('action');
                     console.log('go to : '+url);
                     $.ajax({
                        type: "POST",
                        url: url,
                        data: form.serialize(), // serializes the form's elements.
                        success: function(data)
                        {
                             alert(data); // show response from the server.
                        }
                     });
                });
            },
            changeRoom:function(){
               var el=$('#typeGame');
               console.log(el);
               console.log(el.val());
               for(var i=0; i<this.gameSett.length;i++){
                  if (this.gameSett[i].typeGame == el.val()){
                     //maxCountUser
                     Room.init(this.gameSett[i].maxCountUser);
                  }
               }

            },
            createForm: function() {
                this.dialog = $('#createForm').dialog({
                    autoOpen: false,
                    resizable: false,
                    width: 400,
                    show: { effect: 'drop', direction: "up" },
                    modal: true,
                    draggable: true,
                    buttons: [{
                        text: "Создать игру",
                        "class": "btn-add-properties",
                        click: function() {
                            var form = $('form', this);
                            $.post(form.prop('action'),
                                    form.serialize(),
                                    function(response) {
                                       alert("Game is created");
                                    })
                                .fail(function() {
                                    alert("error");
                                });
                            $("#createForm").dialog('close');
                        }
                    }, {
                        text: "Отмена",
                        "class": "btn-add-properties",
                        click: function() {
                            $("#createForm").dialog('close');
                        }
                    }]
                });
            },              
            isUserInList(users){
            	for(var i=0; i<users.length;i++){
            	   if(this.user.name==users[i]){
            	       return true;
            	   }
            	}
                return false;
            },
            loadAllGame: function() {
                var thisEl = this;
                jQuery.ajax({
                    url: "/games/room/getAllRoom",
                    dataType: "json",
                    type: "GET"
                }).done(function(data) {      
                    $('#listGames').empty();
                    if (data != null && data.length != 0) {
                        for (var i = 0; i < data.length; i++) {
                        	var elD = $('<div><input type="hidden" value="' + data[i].nameRoom + '"><span>' + data[i].typeRoom + ' ' + (parseInt(data[i].nameRoom) + 1) + ' (' + data[i].roomUsers.length + '/' + data[i].maxCountUser + ') ' + '</span></div>');
                        	if(data.roomUsers != null && thisEl.isUserInList(data.roomUsers)){
                                   var buttonD = $('<a href="/gotogame">Перейти в игру</a>');
                            
                                   elD.append(buttonD);
                         	}else{
                                  var buttonD = $('<button value="Присоединиться">Присоединиться</button>');
                            
                                  elD.append(buttonD);
                            }
                            $('#listGames').append(elD);
                            thisEl.createCl(buttonD, data[i].nameRoom);
                        }
                    } else {
                        jQuery('#listGames').empty();                        
                  
                }).always(function() {
                    setTimeout(function() {
                        thisEl.loadAllGame()
                    }, 3000);
                });
            },
            loadRoomSettings: function() {
                var thisEl = this;
                jQuery.ajax({
                    url: "/roomInfo",
                    dataType: "json",
                    type: "GET"
                }).done(function(data) {
                    console.log(data);
                    if (data != null) {
                        thisEl.gameSett = data.roomSettings;
                        thisEl.user = data.user;
                        if (thisEl.gameSett.length ] != null && thisEl.gameSett.length != 0) {
                           for (var i = 0; i < thisEl.gameSett.length; i++) {
                               $('#typeGame').append('<option value="'+thisEl.gameSett[i].typeGame+'">'+thisEl.gameSett[i].typeGame+'</option>');                                                                        
                           }
                           Room.init(thisEl.gameSett[0].maxCountUser);
                        }
                    } else {
                        jQuery('#listGames').append('<div style="color:red">Ошибка загрузки данных</>');                        
                    }
                });
            }, 
            createCl: function(buttonD, numberRoom) {
                var thisEl = this;
                buttonD.click(function() {
                    thisEl.joinRoom(numberRoom);
                });
            },            
            joinRoom: function(numberRoom) {
                document.location.href = "/games/monopoly/" + numberRoom + "/joinRoom.html";
            }
        }
        $(function() {
            objRoom.init();
        })
    </script>
</body>

</html>
