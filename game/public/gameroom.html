<html>

<head>
    <title>Login Here</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script type="text/javascript" src="js/YConsole-compiled.js"></script>
    <script type="text/javascript">
YConsole.activate();
   console.log("first intercepted log.");
   YConsole.docking="bottom";
        YConsole.show();
    </script>
</head>

<body class="container">
    <div class="page-header">
        <h1>Game Room</h1>
    </div>

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/">Home</a></li>
                    <li><a href="/signup">Sign Up</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/login">Log In</a></li>
                    <li><a href="/logout">Log Out</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <div style="margin: 20px">
        <div class="creategame" style="">
            <button value="Создать игру" id="butCreateGame">Создать игру</button>
            
        </div>
    </div>

    <form id="createForm" action="/gameroom" method="post" style="display:none;">
        Type game:
        <select id="typeGame" name="typegame">
            
        </select>

        <div id="silImg" style="margin:5px 15px;"></div>
        <input type="hidden" name="countUs" value="2"/>
    </form>

    <div id="listGames" style="min-height: 500px;">

    </div>

    <script type="application/javascript">
     var Room = {
            this.countUs = 2;
            init: function() {
                var thisEl = this;
                var imgSel = $('<img src="/images/siluetsel.png" width="20"/>').attr("ind", "2");
                jQuery('#silImg').append(imgSel).append(imgSel.clone().attr("ind", "2")).append(imgSel.clone().attr("ind", "3")).append(imgSel.clone().attr("ind", "4"));
                this.unsel(2);
                $('#silImg img').click(function(el) {
                    thisEl.unsel(parseInt($(el.target).attr('ind')))
                });
                
                this.loadUserData();
                $('#butCreateGame').click(function() {
                    thisEl.createGame();
                });
                this.createForm();
            },
            unselSiluet: function(el, ind) {
                if (ind == 0) {
                    unsel(ind);
                }
            },
            unsel: function(ind) {
                this.countUs = ind;
                var mi = $("#silImg img");
                mi.attr('src', '/images/siluetsel.png');
                for (var i = ind; i < mi.length; i++) {
                    $(mi[i]).attr('src', '/images/siluet.png');
                }
            },

            loadRoomData: function() {
                return;
                var thisEl = this;
                jQuery.ajax({
                    url: "/room/gameData",
                    dataType: "json",
                    type: "GET"
                }).done(function(data) {
                    if (data != null) {
                        //                    if(data.activeRooms.length>0){
                        //                         $('#butCreateGame').attr("disabled","disabled");
                        //                    }
                    }
                }).always(function() {
                    setTimeout(function() {
                        thisEl.loadUserData()
                    }, 3000);
                });
            },
      }


        var objRoom = {            
            init: function() {
                var thisEl = this;
                this.loadTypeRoom();
                this.loadAllGame();
                this.createForm();
                $('#butCreateGame').click(function() {
                    thisEl.createGame();
                });                
            },
            createForm: function() {
                this.dialog = $('#createForm').dialog({
                    autoOpen: false,
                    resizable: false,
                    width: 400,
                    show: { effect: 'drop', direction: "up" },
                    modal: true,
                    draggable: true,
                    buttons: [{
                        text: "Создать игру",
                        "class": "btn-add-properties",
                        click: function() {
                            var form = $('form', this);
                            $.post(form.prop('action'),
                                    form.serialize(),
                                    function(response) {
                                        alert("success " + response);
                                    })
                                .fail(function() {
                                    alert("error");
                                });
                            $("#createForm").dialog('close');
                        }
                    }, {
                        text: "Отмена",
                        "class": "btn-add-properties",
                        click: function() {
                            $("#createForm").dialog('close');
                        }
                    }]
                });
            },
            
            
            loadAllGame: function() {
                var thisEl = this;
                jQuery.ajax({
                    url: "/games/room/getAllRoom",
                    dataType: "json",
                    type: "GET"
                }).done(function(data) {
                    console.log(data);
                    if (data != null && data.length != 0) {
                        for (var i = 0; i < data.length; i++) {
                            var buttonD = $('<button value="Присоединиться">Присоединиться</button>');
                            var elD = $('<div><input type="hidden" value="' + data[i].numberRoom + '"><span>' + data[i].typeRoom + ' #' + (parseInt(data[i].numberRoom) + 1) + ' (' + data[i].countUsers + '/' + data[i].maxCountUser + ') ' + '</span></div>');
                            elD.append(buttonD);
                            $('#listGames').empty().append(elD);
                            thisEl.createCl(buttonD, data[i].numberRoom);
                        }
                    } else {
                        jQuery('#listGames').empty();                        
                    }
                }).always(function() {
                    setTimeout(function() {
                        thisEl.loadAllGame()
                    }, 3000);
                });
            },
            loadTypeRoom: function() {
                var thisEl = this;
                jQuery.ajax({
                    url: "/typeRoom",
                    dataType: "json",
                    type: "GET"
                }).done(function(data) {
                    console.log(data);
                    if (data != null && data.length != 0) {
                        for (var i = 0; i < data.length; i++) {

                            $('#typeGame').append('<option value="'+typeGame+'">'+typeGame+'</option>');
                            

                            //maxCountUser
                            Room.init(data.maxCountUser);


                            
                        }
                    } else {
                        jQuery('#listGames').append('<div style="color:red">Ошибка загрузки данных</>');                        
                    }
                });
            }, 

            createCl: function(buttonD, numberRoom) {
                var thisEl = this;
                buttonD.click(function() {
                    thisEl.joinRoom(numberRoom);
                });
            },
            createGame: function() {
                //  document.location.href="/games/monopoly/createroom.html?countgameuser="+this.countUs;
                this.dialog.dialog('open');
            },
            joinRoom: function(numberRoom) {
                document.location.href = "/games/monopoly/" + numberRoom + "/joinRoom.html";
            }
        }
        $(function() {
            objRoom.init();
        })
    </script>
</body>

</html>
